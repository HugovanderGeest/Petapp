<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='main.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    />
    <title>Admin</title>
  </head>

  <body>
    <img
      src="{{ url_for('static', filename='logo.png') }}"
      alt="CircularPET Logo"
      class="logo2"
    />
    <div class="gear-icon-container">
      <i id="toggleSidebar" class="fa fa-bars"></i>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %} {% endif %} {% endwith %}

    <div class="sidebar" style="display: none">
      <!-- BEGIN: Changed the initial display to none -->
      <h2 class="side-titel">
        {{ current_user.username if current_user.is_authenticated else 'Admin'
        }}
      </h2>
      {% if current_user.is_admin %}
      <h3>Admin</h3>
      {% else %}
      <h3>Controleur</h3>
      {% endif %}

      <div class="max-man">
        <a href="{{ url_for('admin') }}">
          <div class="active side-link">
            <i class="fas fa-user"></i>
            <p>Admin</p>
          </div>
        </a>

        <a href="{{ url_for('change_log') }}">
          <div class="side-link">
            <i class="fas fa-book"></i>
            <p>Data</p>
          </div>
        </a>

        <a href="{{ url_for('check_ins') }}">
          <div class="side-link">
            <i class="fas fa-check"></i>
            <p>Check</p>
          </div>
        </a>

        <a href="{{ url_for('view_photos') }}">
          <div class="side-link">
            <i class="fas fa-images"></i>
            <p>Foto's</p>
          </div>
        </a>

        <a href="{{ url_for('show_briefings') }}">
          <div class="side-link">
            <i class="fas fa-file"></i>
            <p>Briefings</p>
          </div>
        </a>

        <a href="{{ url_for('bar_notes') }}">
          <div class="side-link">
            <i class="fas fa-pen"></i>
            <p>Notities</p>
          </div>
        </a>

        <a href="{{ url_for('index') }}">
          <div class="side-link">
            <i class="fas fa-arrow-left"></i>
            <p>Log-uit</p>
          </div>
        </a>
      </div>
    </div>

    <div class="cube-container">
      <div class="formenzo">
        <div class="login-form" id="userForm" style="display: none">
          <form method="POST">
            <h2 class="cube-titel">Maak gebruiker aan</h2>
            {{ form.hidden_tag() }} {{ form.username.label }} {{ form.username()
            }} <br /><br />
            {{ form.password.label }} {{ form.password() }} <br /><br />
            {{ form.email.label }} {{ form.email() }} <br /><br />
            {{ form.phone_number.label }} {{ form.phone_number() }} <br /><br />
            {{ form.is_admin.label }} {{ form.is_admin() }} <br /><br />

            {{ form.submit() }}
          </form>
        </div>

        <div class="login-form" id="locationForm" style="display: none">
          <form method="POST">
            <h2 class="cube-titel">Maak Locatie aan</h2>
            {{ location_form.hidden_tag() }}
            <p>
              {{ location_form.name.label }}<br />
              {{ location_form.name(size=20) }}
            </p>
            <p>{{ location_form.submit() }}</p>
          </form>
        </div>
      </div>
    </div>

    <a onclick="toggleForms()" class="fab" aria-label="plus">
      <i class="fas fa-plus"></i>
    </a>

    <div class="search-container minderje">
      <form class="zoekenn" action="{{ url_for('admin') }}" method="get">
        <input
          type="text"
          id="userSearchInput"
          onkeyup="sortUsers()"
          placeholder="Zoeken..."
        />
      </form>
    </div>

    <div class="titels">
      <p>Naam</p>
      <p>Locatie</p>
      <p>Email</p>
      <p>Telefoon</p>
    </div>

    {% for user in users %}

    <div class="user-info">
      <img
        src="{{ user.profile_picture if user.profile_picture else url_for('static', filename='stock.png') }}"
        alt="Profile Picture"
        class="user-profile-pic"
      />

      <a href="{{ url_for('user_dashboard', user_id=user.id) }}">
        <div class="fijv">
          <p>{{ user.username }}</p>
        </div>
      </a>

      {% if user.location %}

      <a
        href="{{ url_for('location', user_id=user.id, location_id=user.location.id) }}?user_id=1&from_admin=true"
      >
        <div class="fijv">
          <p>{{ user.location.name }}</p>
        </div>
      </a>

      {% else %}
      <a href="#">
        <div class="fijv">
          <p>Geen</p>
        </div>
      </a>
      {% endif %}

      <a href="mailto:{{ user.email }}">
        <div class="fijv meerje">
          <p>{{ user.email }}</p>
        </div>
      </a>

      <a href="tel:{{ user.phone_number }}">
        <div class="fijv rietje">
          <p>{{ user.phone_number }}</p>
        </div>
      </a>
    </div>
    {% endfor %}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $("#toggleSidebar").click(function () {
          // Toggle the visibility of the sidebar with a slide animation
          $(".sidebar").slideToggle();
        });
      });
    </script>
    <script>
      $(document).ready(function () {
        $("#createUserForm").submit(function (event) {
          event.preventDefault(); // Prevent the default form submission
          $.ajax({
            url: "/path/to/your/user/creation/route", // Update with your route
            type: "POST",
            data: $(this).serialize(), // Serialize form data
            success: function (response) {
              // Assuming response contains user data, e.g., { id: 123, username: "newUser" }
              $("#userList").append(
                `<li id="user-${response.id}"><a href="/user_dashboard/${response.id}">${response.username}</a></li>`
              );
            },
            error: function (xhr, status, error) {
              // Handle errors (optional)
              console.error("Error creating user:", status, error);
            },
          });
        });
      });
    </script>

    <script>
      function sortTable(column) {
        var table, rows, switching, i, x, y, shouldSwitch;
        table = document.querySelector(".custom-table tbody"); // Focus on tbody only
        switching = true;
        while (switching) {
          switching = false;
          rows = table.rows;
          for (i = 0; i < rows.length - 1; i++) {
            // Adjusted loop to account for tbody rows only
            shouldSwitch = false;
            x =
              rows[i].getElementsByTagName("TD")[
                column === "username" ? 0 : column === "location" ? 1 : 2
              ];
            y =
              rows[i + 1].getElementsByTagName("TD")[
                column === "username" ? 0 : column === "location" ? 1 : 2
              ];
            if (x.innerText.toLowerCase() > y.innerText.toLowerCase()) {
              // Using innerText for comparison
              shouldSwitch = true;
              break;
            }
          }
          if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
          }
        }
      }
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
      $(document).ready(function () {
        $(".toggle-button").click(function () {
          var formContainer = $(this).next(".form-container");
          // Debugging output
          console.log(formContainer.length); // Should log 1 if the form container is correctly selected

          var isOpen = formContainer.css("max-height") !== "0px";
          console.log("Is open:", isOpen); // Debugging: Check if detected as open

          if (isOpen) {
            formContainer.css("max-height", 0);
            $(this).text("+");
          } else {
            formContainer.css("max-height", "none");
            var scrollHeight = formContainer.prop("scrollHeight");
            console.log("Scroll Height:", scrollHeight); // Should log a positive number

            formContainer.css("max-height", 0); // Ensure CSS transition can occur
            setTimeout(() => {
              formContainer.css("max-height", scrollHeight + "px");
              $(this).text("-");
            }, 10);
          }
        });
      });
    </script>

    <script>
      function toggleForms() {
        var userForm = document.getElementById("userForm");
        var locationForm = document.getElementById("locationForm");
        var formenzo = document.querySelector(".formenzo");
        var overlay = document.getElementById("overlay");

        // Check if overlay exists, if not, create it
        if (!overlay) {
          overlay = document.createElement("div");
          overlay.id = "overlay";
          overlay.className = "overlay";
          document.body.appendChild(overlay);
        }

        // Toggle forms display
        userForm.style.display =
          userForm.style.display === "none" ? "block" : "none";
        locationForm.style.display =
          locationForm.style.display === "none" ? "block" : "none";

        // If either form is visible, show overlay and apply z-index to formenzo
        if (
          userForm.style.display === "block" ||
          locationForm.style.display === "block"
        ) {
          overlay.style.display = "block";
          formenzo.classList.add("formenzo-active");
        } else {
          overlay.style.display = "none";
          formenzo.classList.remove("formenzo-active");
        }

        // When overlay is clicked, hide forms and remove overlay
        overlay.onclick = function () {
          userForm.style.display = "none";
          locationForm.style.display = "none";
          overlay.style.display = "none";
          formenzo.classList.remove("formenzo-active");
        };
      }
    </script>

    <script>
      function sortUsers() {
        var input = document.getElementById("userSearchInput");
        var filter = input.value.toLowerCase();
        var userDivs = document.getElementsByClassName("user-info");

        // Loop through all user-info divs and toggle display based on match
        for (var i = 0; i < userDivs.length; i++) {
          // Check if username or location contains the search term
          var usernameDiv = userDivs[i].getElementsByClassName("fijv")[0];
          var username = usernameDiv.textContent || usernameDiv.innerText;

          var locationDiv = userDivs[i].getElementsByClassName("fijv")[1];
          var location = locationDiv
            ? locationDiv.textContent || locationDiv.innerText
            : "";

          if (
            username.toLowerCase().indexOf(filter) > -1 ||
            location.toLowerCase().indexOf(filter) > -1
          ) {
            userDivs[i].style.display = "";
          } else {
            userDivs[i].style.display = "none";
          }
        }
      }
    </script>

    <script>
      document
        .querySelector(".custom-table")
        .addEventListener("click", function (event) {
          if (event.target.tagName !== "A") {
            event.stopPropagation(); // Stop propagation only if it's not an <a> tag
          }
        });
    </script>
  </body>
</html>
